"use strict";(self.webpackChunkwhg_training_resources=self.webpackChunkwhg_training_resources||[]).push([[3338],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var r=a.createContext({}),p=function(e){var t=a.useContext(r),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(r.Provider,{value:t},e.children)},u="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,r=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),d=o,m=u["".concat(r,".").concat(d)]||u[d]||h[d]||i;return n?a.createElement(m,s(s({ref:t},c),{},{components:n})):a.createElement(m,s({ref:t},c))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,s=new Array(i);s[0]=d;var l={};for(var r in t)hasOwnProperty.call(t,r)&&(l[r]=t[r]);l.originalType=e,l[u]="string"==typeof e?e:o,s[1]=l;for(var p=2;p<i;p++)s[p]=n[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},9621:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>r,contentTitle:()=>s,default:()=>h,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var a=n(7462),o=(n(7294),n(3905));const i={sidebar_position:6},s="Computing principal components",l={unversionedId:"population_genetics/principal_components_analysis/computing_PCs",id:"population_genetics/principal_components_analysis/computing_PCs",title:"Computing principal components",description:"If you've reached this page, you should now have downloaded the data,",source:"@site/docs/population_genetics/principal_components_analysis/computing_PCs.md",sourceDirName:"population_genetics/principal_components_analysis",slug:"/population_genetics/principal_components_analysis/computing_PCs",permalink:"/whg-training-resources/population_genetics/principal_components_analysis/computing_PCs",draft:!1,editUrl:"https://github.com/whg-training/whg-training-resources/edit/main/docs/population_genetics/principal_components_analysis/computing_PCs.md",tags:[],version:"current",sidebarPosition:6,frontMatter:{sidebar_position:6},sidebar:"sidebar7",previous:{title:"Removing closely-related samples",permalink:"/whg-training-resources/population_genetics/principal_components_analysis/relatedness_pruning"},next:{title:"Plotting samples against a global reference panel",permalink:"/whg-training-resources/population_genetics/principal_components_analysis/global_analysis"}},r={},p=[{value:"Computing PCs",id:"computing-pcs",level:2},{value:"Plotting the principal components",id:"plotting-the-principal-components",level:2},{value:"Plotting SNP weights or &#39;loadings&#39;",id:"plotting-snp-weights-or-loadings",level:2},{value:"Plotting samples against a global dataset",id:"plotting-samples-against-a-global-dataset",level:3}],c={toc:p},u="wrapper";function h(e){let{components:t,...n}=e;return(0,o.kt)(u,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"computing-principal-components"},"Computing principal components"),(0,o.kt)("p",null,"If you've reached this page, you should now have downloaded the data,\n",(0,o.kt)("a",{parentName:"p",href:"/whg-training-resources/population_genetics/principal_components_analysis/ld_pruning"},"computed an LD-pruned set of SNPs"),", and also ",(0,o.kt)("a",{parentName:"p",href:"/whg-training-resources/population_genetics/principal_components_analysis/relatedness_pruning"},"computed a set of largely unrelated samples to work with"),". Congratulations - you're now ready to compute principal components!"),(0,o.kt)("h2",{id:"computing-pcs"},"Computing PCs"),(0,o.kt)("p",null,"Let's go ahead and use plink to compute the PCs:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"plink --vcf chr19-clean.vcf.gz --extract chr19-clean.prune.in --remove related_samples.txt --pca var-wts --out chr19-clean\n")),(0,o.kt)("p",null,"Leave this to run for a minute or so."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Question"),". It's always worth inspecting screen output to check things look right.  For example, has plink excluded\nthe right number of samples we told it to?"),(0,o.kt)("p",null,"Towards the end of the output plink will tell us where it has saved the results. These should be in\nthe files ",(0,o.kt)("inlineCode",{parentName:"p"},"chr19-clean.eigenvec")," (which stores the actual PCs), ",(0,o.kt)("inlineCode",{parentName:"p"},"chr19-clean.eigenvec.var")," (which\nstores the SNP weights or loadings, reflecting how much each SNP contributes to each PC), and\n",(0,o.kt)("inlineCode",{parentName:"p"},"chr19-clean.eigenval")," (which says how much of the overall genotypic variance each PC explains)."),(0,o.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"An aside on the maths")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"If you want to know more about what is being computed and how - see ",(0,o.kt)("a",{parentName:"p",href:"/whg-training-resources/population_genetics/principal_components_analysis/the_maths"},"this aside on the maths of principal components\nanalysis"),"."),(0,o.kt)("p",{parentName:"div"},"And if all this isn't enough\n",(0,o.kt)("a",{parentName:"p",href:"https://doi.org/10.1371/journal.pgen.1000686"},"try reading this seminal paper on sample genealogies and PCA"),"."))),(0,o.kt)("h2",{id:"plotting-the-principal-components"},"Plotting the principal components"),(0,o.kt)("p",null,"Now let's load the PCs and plot them:"),(0,o.kt)("p",null,"In R/RStudio:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-R"},'pcs = read.table( "chr19-clean.eigenvec", as.is = T )\ncolnames(pcs)[1:7] = c( "group", "ID", "PC1","PC2","PC3","PC4","PC5" )\nView(pcs)\nplot( pcs$PC1, pcs$PC2, pch = 19, xlab = "PC1", ylab = "PC2" )\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Question"),". What do you see?  Is there any obvious structure in the dataset?  "),(0,o.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"I used ",(0,o.kt)("inlineCode",{parentName:"p"},"pch = 19")," above because that gives us solid dots instead of open circles.  See ",(0,o.kt)("a",{parentName:"p",href:"https://r-graphics.org/recipe-scatter-shapes"},"here for a diagram of available shapes in R"),"."))),(0,o.kt)("p",null,"We might also want to plot more than just the top two PCs. Let's plot all pairs of the top 5 PCs:"),(0,o.kt)("p",null,"In R/RStudio:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-R"},"pairs( pcs[, 3:7], pch = 19 )\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Hint"),": In Rstudio, you can click the 'zoom' button above above the plot to get a bigger version."),(0,o.kt)("p",null,"Our dataset contains samples with different ethnicities that in our dataset are recorded in the\nfirst column of the file (plink calls this a 'family ID' but here we've used it to record sampled\nethnicities). Make a list of them using ",(0,o.kt)("inlineCode",{parentName:"p"},"table()"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-R"},"table( pcs$group )\n")),(0,o.kt)("p",null,"Different ethnic groups might be genetically distinct, so they might separate on the PCs. Let's\nreplot colouring points by their ethnicity. We'll do this in three steps:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Turn ethnicities into integers that we can pass to the col argument of ",(0,o.kt)("inlineCode",{parentName:"li"},"plot()"),"."),(0,o.kt)("li",{parentName:"ol"},"Plot using the colours"),(0,o.kt)("li",{parentName:"ol"},"Add a legend to the plot so we can see what is what.")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Note.")," The ",(0,o.kt)("inlineCode",{parentName:"p"},"lower.panel")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"xpd")," arguments below are used to tweak the appearance of the plot and how the legend is plotted.  See ",(0,o.kt)("inlineCode",{parentName:"p"},"?pairs")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"?par")," if you want more information, but don't worry about these for now."),(0,o.kt)("p",null,"In R/RStudio:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-R"},'# ensure group is not a factor!\npcs$group = as.character( pcs$group )\npalette = c( CAN = "red2", FAN = "green2", JAN = "blue2", WAN = "yellow3" )\npcs$colour = palette[ pcs$group ]\npairs( pcs[,3:7], col = pcs$colour, pch=20, lower.panel = NULL )\nlegend(\n  0.1, 0.5,\n  col = palette,\n  legend = names( palette ),\n  pch=20,\n  xpd=NA   # this is used to allow drawing outside the plot.\n)\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Question"),". Do the principal components reflect ethnicities in this dataset?  Which ethnicities are separated by which PCs? "),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Question"),". Do any samples look especially genetically distinct from the other samples? What might be the reason for this?  Is the same set of samples outlying on all the PCs?  Use your R skills to identify these samples.  "),(0,o.kt)("h2",{id:"plotting-snp-weights-or-loadings"},"Plotting SNP weights or 'loadings'"),(0,o.kt)("p",null,"But we are not done yet! If we want to look at population structure, we generally want PCs that\nrepresent genome-wide variation in allele frequencies (as opposed to variants clustered in specific\nregions.) To check this we should also plot the loadings."),(0,o.kt)("p",null,"To do this, examine the ",(0,o.kt)("inlineCode",{parentName:"p"},"chr19-clean.eigenvec.var")," file that plink produced. We'll load it\ninto R and plot loadings across the chromosome."),(0,o.kt)("p",null,"In R/RStudio:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-R"},'loadings = read.table("chr19-clean.eigenvec.var")\ncolnames(loadings)[1:4] = c( "chromosome", "rsid", "alleleA", "alleleB" )\nView(loadings)\n')),(0,o.kt)("p",null,"Columns 3-22 of this file represent the loadings on PCs 1-20, respectively.  Let's plot loadings for the first 5 PCs.  Here we can use the ",(0,o.kt)("inlineCode",{parentName:"p"},"layout()")," function to make a plot with multiple rows.  The ",(0,o.kt)("inlineCode",{parentName:"p"},"par( mar = ...)")," command adjusts the plot margins.)"),(0,o.kt)("p",null,"In R/RStudio:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-R"},'layout( matrix( 1:5, ncol = 1 ))\npar( mar = c( 1, 4, 1, 2 ))\nfor( i in 1:5 ) {\n  plot(\n    1:nrow(loadings),\n    # we plot the absolute value of the loading, so they all go up\n    abs( loadings[,i+4] ),  \n    ylab = paste("PC ", i, sep = "" ),\n    ylim = c( 1, 10 ),\n    pch = 19\n  )\n  legend( "topleft", legend = sprintf( "Loadings for PC %d", i ), bty = \'n\' )\n}\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Question"),". Do any SNPs stand out as having high loadings for particular PCs?  Which PCs?  Look back at your plot of principal components.  Do these PCs pick out particular clusters of samples?"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Question"),". Go back and compute PCs without excluding related samples.  E.g. something like this, without the ",(0,o.kt)("inlineCode",{parentName:"p"},"--remove")," option:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"plink --vcf chr19-clean.vcf.gz --extract chr19-clean.prune.in --pca var-wts --out chr19-all_samples\n")),(0,o.kt)("p",null,"Then re-load and plot both the PCs and loadings.  What drives the top PCs now?  What do the loadings look like?"),(0,o.kt)("h3",{id:"plotting-samples-against-a-global-dataset"},"Plotting samples against a global dataset"),(0,o.kt)("p",null,"A last step in many analyses is to check the ancestry of samples against a global dataset - to check for example that no unexpected ancestries are included.  We'll do that ",(0,o.kt)("a",{parentName:"p",href:"/whg-training-resources/population_genetics/principal_components_analysis/global_analysis"},"on the next page"),"."))}h.isMDXComponent=!0}}]);